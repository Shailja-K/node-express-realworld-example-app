// Parameters:
//  branch       - branch of the source code repo to build.

@Library('jenkins_shared_lib') _

pipeline
{
	agent { label 'osposcan1' }
	stages
	{
		stage('Checkout')
		{
			steps
			{
				// check out the repo that contains this JenkinsFile, because that's
				// where the blackduck.config file lives
				checkout([$class: 'GitSCM',
				          branches: [[name: "master"]],
				                    extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'scan-jenkinsfiles']],
				                    userRemoteConfigs: [[credentialsId: 'SKumari_Jenkins',
									url: 'https://bitbucket.analog.com/scm/ospo/scan-jenkinsfiles.git']]])

				// Check out the sources we want to scan
				checkout([$class: 'GitSCM',
				          branches: [[name: "master"]],
				          extensions: [[$class: 'CleanCheckout'],
				                       [$class: 'SubmoduleOption',
				                          disableSubmodules: false, parentCredentials: true,
				                          recursiveSubmodules: true, reference: '',
				                          shallow: true, trackingSubmodules: false],
				                       [$class: 'CloneOption', noTags: false, reference: '', shallow: true],
				                       [$class: 'PruneStaleBranch']],
										userRemoteConfigs: [[credentialsId: 'SKumari_Jenkins',
				                            url: 'https://bitbucket.analog.com/scm/dte-inf/bd-cli.git']]])
			}
		}
		stage('Black Duck')
		{
			steps
			{
				sh "/opt/osposcan/Python-3.8.3/python -m venv .venv"
				sh ".venv/bin/pip3 install --upgrade pip"
				sh "ls -a"
				sh ".venv/bin/pip3 install -r requirements.txt"
				
				sh "echo Using scan-jenkinsfiles/bdcli/blackduck.config && cat scan-jenkinsfiles/bdcli/blackduck.config"
				script { synopsys.detect { configFile = 'scan-jenkinsfiles/bdcli/blackduck.config' } }
			}
		}
//		stage('Clean up')
//		{
//			steps
//			{
//				cleanWs()
//			}
//		}
	}
    
	post
	{
		failure
		{
			emailext body: 'Jenkins build failure. The link is ${BUILD_URL}.', recipientProviders: [developers()], subject: 'Oops - Job ${JOB_NAME} (${BUILD_NUMBER}) failed', to: 'shailja.kumari@analog.com'
		}
	}
}

